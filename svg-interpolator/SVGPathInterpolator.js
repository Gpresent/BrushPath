import { SaxEventType } from './sax-wasm/lib/module/index.js';
import { calculators } from './math/calculators.js';
import { SVGTransform } from './math/SVGTransform.js';
const commandRegEx = /(m|l|c|q|z|a|v|h|s|z)(?: ?)([\d+-., ]*)/ig;
const argumentsRegEx = /([-]?\d+\.*\d*)(?:,| )?/g;
const transformRegEx = /(matrix|translate|scale|rotate|skewX|skewY)(?:\()(.*)(?:\))/;
export class SVGPathInterpolator {
    /**
     * When trim is true, paths that were translated
     * are normalized and will begin at 0,0.
     *
     * @var {boolean} trim
     * @memberOf SVGPathInterpolator#
     * @default false
     */
    trim = false;
    /**
     * minDistance is the minimum distance between the
     * current and previous points when sampling.
     * If a sample results in a distance less than the
     * specified value, the point is discarded.
     *
     * @var {number} minDistance
     * @memberOf SVGPathInterpolator#
     * @default 0.5
     */
    minDistance = 0.5;
    /**
     * roundToNearest is useful when snapping to fractional
     * pixel values. For example, if roundToNearest is .25,
     * a sample resulting in the point 2.343200092,4.6100923
     * will round to 2.25,4.5.
     *
     * @var {number} roundToNearest
     * @memberOf SVGPathInterpolator#
     * @default 0.25
     */
    roundToNearest = 0.25;
    /**
     * sampleFrequency determines the increment of t when sampling.
     * If sampleFrequency is set to .001 , since t iterates from
     * 0 to 1, there will be 1000 points sampled per command
     * but only points that are greater than minDistance are captured.
     *
     * @var {number} sampleFrequency
     * @memberOf SVGPathInterpolator#
     * @default 0.001
     */
    sampleFrequency = 0.001;
    /**
     * When true, pretty creates formatted json output.
     *
     * @var {boolean} pretty
     * @memberOf SVGPathInterpolator#
     * @default false
     */
    pretty = false;
    /**
     * Then number of spaces to indent when pretty is true.
     *
     * @var {int} prettyIndent
     * @memberOf SVGPathInterpolator#
     * @default 0
     */
    prettyIndent = 0;
    /**
     * Whether to join path data into a single flat array.
     *
     * @var {boolean} joinPathData
     * @memberOf SVGPathInterpolator#
     * @default false
     */
    joinPathData = false;
    /**
     * The SaxWasm parser instance;
     * @var { SAXParser } parser
     * @memberOf SVGPathInterpolator#
     * @default null
     */
    parser;
    constructor(config = {
        joinPathData: false,
        minDistance: +0.5,
        roundToNearest: +0.25,
        sampleFrequency: +0.001,
        parser: null
    }) {
        Object.assign(this, config);
    }
    parseArguments(source) {
        const args = [];
        let arg;
        while (arg = argumentsRegEx.exec(source)) {
            if (isFinite(+arg[1])) {
                args.push(+arg[1]);
            }
            else {
                args.push(arg[1]);
            }
        }
        return args;
    }
    processSVG(data) {
        const openTagsDepth = {};
        const transforms = {};
        let interpolatedPaths = this.joinPathData ? [] : {};
        let i = Date.now();
        this.parser.eventHandler = (event, node) => {
            if (event === SaxEventType.OpenTag) {
                if (!openTagsDepth[node.name]) {
                    openTagsDepth[node.name] = 0;
                }
                const depth = openTagsDepth[node.name]++;
                const transform = node.attributes.find(attr => attr.name.value === 'transform');
                if (transform) {
                    transforms[depth + node.name] = transform.value.value;
                }
                if (node.name === 'path') {
                    const p = node.attributes.find(attr => attr.name.value === 'd');
                    const points = this.interpolatePath(p.value.value);
                    this.applyTransforms(transforms, points);
                    if (!this.joinPathData) {
                        const id = node.attributes.find(attr => attr.name.value === 'id');
                        const key = id ? id.value.value : `path_${i++}`;
                        interpolatedPaths[key] = points;
                    }
                    else {
                        interpolatedPaths = interpolatedPaths.concat(points);
                    }
                }
            }
            else {
                const depth = --openTagsDepth[node.name];
                delete transforms[depth + node.name];
            }
        };
        this.parser.write(data);
        this.parser.end();
        return interpolatedPaths;
    }
    applyTransforms(transforms, points) {
        const keys = Object.keys(transforms);
        if (!keys.length) {
            return;
        }
        if (keys.length < 1) {
            keys.sort().reverse();
        }
        keys.forEach(depth => {
            const svgTransform = new SVGTransform();
            const rawTransform = transforms[depth];
            const [, type, rawArguments] = transformRegEx.exec(rawTransform);
            const args = this.parseArguments(rawArguments);
            svgTransform[type].call(svgTransform, ...args);
            const len = points.length;
            for (let i = 0; i < len; i += 2) {
                const { x, y } = svgTransform.map(points[i], points[i + 1]);
                points[i] = x - (x % this.roundToNearest);
                points[i + 1] = y - (y % this.roundToNearest);
            }
        });
    }
    interpolatePath(path) {
        const data = [];
        let subPathStartX = 0;
        let subPathStartY = 0;
        let offsetX = 0;
        let offsetY = 0;
        let args;
        let match;
        let lastCommand = { command: '', points: undefined, offsets: undefined };
        while (match = commandRegEx.exec(path)) {
            const [, command, rawArguments] = match;
            let points = this.parseArguments(rawArguments);
            switch (command) {
                case 'A':
                case 'C':
                case 'L':
                case 'Q':
                    points.unshift(offsetX, offsetY);
                    args = [points];
                    break;
                case 'S':
                case 's':
                case 'T':
                case 't':
                    let lastCtrlX;
                    let lastCtrlY;
                    const { command: lastC, points: lastP } = lastCommand;
                    const reg = command.toLowerCase() === 's' ? /^[cs]$/ : /^[qt]$/;
                    if (reg.test(lastC.toLowerCase())) {
                        const { length } = lastP;
                        lastCtrlY = lastP[length - 3];
                        lastCtrlX = lastP[length - 4];
                    }
                    args = points;
                    if (/^[st]$/.test(command)) {
                        this.applyOffset(offsetX, offsetY, args, 4);
                    }
                    args.unshift(offsetX, offsetY, lastCtrlX, lastCtrlY);
                    args = [args];
                    break;
                case 'a':
                    points.unshift(0, 0);
                    args = [this.applyOffset(offsetX, offsetY, points, 7)];
                    break;
                case 'c':
                    this.applyOffset(offsetX, offsetY, points, 6);
                    points.unshift(offsetX, offsetY);
                    args = [points];
                    break;
                case 'l':
                    points.unshift(0, 0);
                    args = [this.applyOffset(offsetX, offsetY, points, 2)];
                    break;
                case 'q':
                    points.unshift(0, 0);
                    args = [this.applyOffset(offsetX, offsetY, points, 4)];
                    break;
                case 'H':
                    points.unshift(offsetX, offsetY);
                    points.push(offsetY);
                    args = [points];
                    break;
                case 'h':
                    this.applyOffset(offsetX, offsetX, points, 2); // offsetX, offsetX is intentional
                    points.unshift(offsetX, offsetY);
                    points.push(offsetY);
                    args = [points];
                    break;
                case 'm':
                    subPathStartX = points[0] + offsetX;
                    subPathStartY = points[1] + offsetY;
                    args = [this.applyOffset(offsetX, offsetY, points.slice(2), 2)];
                    break;
                case 'M':
                    subPathStartX = points[0];
                    subPathStartY = points[1];
                    args = [points.slice(2)];
                    break;
                case 'V':
                    points.unshift(offsetX, offsetY, offsetX);
                    args = [points];
                    break;
                case 'v':
                    this.applyOffset(offsetY, offsetY, points, 2); // offsetY, offsetY is intentional
                    points.unshift(offsetX, offsetY, offsetX);
                    args = [points];
                    break;
                case 'z':
                case 'Z':
                    points = [offsetX, offsetY, subPathStartX, subPathStartY];
                    args = [points];
                    break;
            }
            const calculator = calculators[command.toLowerCase()];
            const offsets = { offsetX, offsetY };
            if (calculator) {
                args.push(this.minDistance, this.roundToNearest, this.sampleFrequency);
                const pts = calculator(...args);
                data.push(...pts);
                const len = ~~points.length;
                offsetY = points[len - 1];
                offsetX = points[len - 2];
            }
            lastCommand = { command, points, offsets };
        }
        if (this.trim) {
            this.trimPathOffsets(data);
        }
        return data;
    }
    trimPathOffsets(paths) {
        let minX = Number.POSITIVE_INFINITY;
        let minY = Number.POSITIVE_INFINITY;
        let i = paths.length;
        let x;
        let y;
        if (!i) {
            return;
        }
        while (i -= 2) {
            x = paths[i];
            y = paths[i - 1];
            if (x < minX) {
                minX = x;
            }
            if (y < minY) {
                minY = y;
            }
        }
        i = paths.length;
        while (i -= 2) {
            paths[i] -= minX;
            paths[i - 1] -= minY;
        }
    }
    applyOffset(offsetX, offsetY, coords = [], setLength = 2) {
        for (let i = 0; i < coords.length; i++) {
            if (i && i % +setLength === 0) {
                offsetX = coords[i - 2];
                offsetY = coords[i - 1];
            }
            coords[i] += (i % 2 ? +offsetY : +offsetX);
        }
        return coords;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU1ZHUGF0aEludGVycG9sYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9TVkdQYXRoSW50ZXJwb2xhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQWtCLHVDQUFpQjtBQUN4RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXRELE1BQU0sWUFBWSxHQUFHLDJDQUEyQyxDQUFDO0FBQ2pFLE1BQU0sY0FBYyxHQUFHLDBCQUEwQixDQUFDO0FBQ2xELE1BQU0sY0FBYyxHQUFHLDZEQUE2RCxDQUFDO0FBVXJGLE1BQU0sT0FBTyxtQkFBbUI7SUFDOUI7Ozs7Ozs7T0FPRztJQUNILElBQUksR0FBRyxLQUFLLENBQUM7SUFFYjs7Ozs7Ozs7O09BU0c7SUFDSCxXQUFXLEdBQUcsR0FBRyxDQUFDO0lBRWxCOzs7Ozs7Ozs7T0FTRztJQUNILGNBQWMsR0FBRyxJQUFJLENBQUM7SUFFdEI7Ozs7Ozs7OztPQVNHO0lBQ0gsZUFBZSxHQUFHLEtBQUssQ0FBQztJQUV4Qjs7Ozs7O09BTUc7SUFDSCxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBRWY7Ozs7OztPQU1HO0lBQ0gsWUFBWSxHQUFHLENBQUMsQ0FBQztJQUVqQjs7Ozs7O09BTUc7SUFDSCxZQUFZLEdBQUcsS0FBSyxDQUFDO0lBRXJCOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFZO0lBRWxCLFlBQVksU0FBZ0M7UUFDMUMsWUFBWSxFQUFFLEtBQUs7UUFDbkIsV0FBVyxFQUFFLENBQUMsR0FBRztRQUNqQixjQUFjLEVBQUUsQ0FBQyxJQUFJO1FBQ3JCLGVBQWUsRUFBRSxDQUFDLEtBQUs7UUFDdkIsTUFBTSxFQUFFLElBQUk7S0FDYjtRQUNDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFF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QyxDQUFDLENBQUM7YUFDekI7WUFDRCxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQSxDQUFDLENBQUEsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMxQztRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNheEV2ZW50VHlwZSwgU0FYUGFyc2VyLCBUYWcgfSBmcm9tICdzYXgtd2FzbSc7XG5pbXBvcnQgeyBjYWxjdWxhdG9ycyB9IGZyb20gJy4vbWF0aC9jYWxjdWxhdG9ycy5qcyc7XG5pbXBvcnQgeyBTVkdUcmFuc2Zvcm0gfSBmcm9tICcuL21hdGgvU1ZHVHJhbnNmb3JtLmpzJztcblxuY29uc3QgY29tbWFuZFJlZ0V4ID0gLyhtfGx8Y3xxfHp8YXx2fGh8c3x6KSg/OiA/KShbXFxkKy0uLCBdKikvaWc7XG5jb25zdCBhcmd1bWVudHNSZWdFeCA9IC8oWy1dP1xcZCtcXC4qXFxkKikoPzosfCApPy9nO1xuY29uc3QgdHJhbnNmb3JtUmVnRXggPSAvKG1hdHJpeHx0cmFuc2xhdGV8c2NhbGV8cm90YXRlfHNrZXdYfHNrZXdZKSg/OlxcKCkoLiopKD86XFwpKS87XG50eXBlIENhbGxhYmxlU3ZnVHJhbnNmb3JtID0ge1tQIGluIGtleW9mIFNWR1RyYW5zZm9ybV06IFNWR1RyYW5zZm9ybVtQXSBleHRlbmRzIENhbGxhYmxlRnVuY3Rpb24gPyBQOiBuZXZlcn1ba2V5b2YgU1ZHVHJhbnNmb3JtXVxuZXhwb3J0IGludGVyZmFjZSBTVkdJbnRlcnBvbGF0b3JDb25maWcge1xuICBqb2luUGF0aERhdGE6IGZhbHNlLFxuICBtaW5EaXN0YW5jZTogbnVtYmVyLFxuICByb3VuZFRvTmVhcmVzdDogbnVtYmVyLFxuICBzYW1wbGVGcmVxdWVuY3k6IG51bWJlcixcbiAgcGFyc2VyOiBTQVhQYXJzZXJcbn1cblxuZXhwb3J0IGNsYXNzIFNWR1BhdGhJbnRlcnBvbGF0b3Ige1xuICAvKipcbiAgICogV2hlbiB0cmltIGlzIHRydWUsIHBhdGhzIHRoYXQgd2VyZSB0cmFuc2xhdGVkXG4gICAqIGFyZSBub3JtYWxpemVkIGFuZCB3aWxsIGJlZ2luIGF0IDAsMC5cbiAgICpcbiAgICogQHZhciB7Ym9vbGVhbn0gdHJpbVxuICAgKiBAbWVtYmVyT2YgU1ZHUGF0aEludGVycG9sYXRvciNcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHRyaW0gPSBmYWxzZTtcblxuICAvKipcbiAgICogbWluRGlzdGFuY2UgaXMgdGhlIG1pbmltdW0gZGlzdGFuY2UgYmV0d2VlbiB0aGVcbiAgICogY3VycmVudCBhbmQgcHJldmlvdXMgcG9pbnRzIHdoZW4gc2FtcGxpbmcuXG4gICAqIElmIGEgc2FtcGxlIHJlc3VsdHMgaW4gYSBkaXN0YW5jZSBsZXNzIHRoYW4gdGhlXG4gICAqIHNwZWNpZmllZCB2YWx1ZSwgdGhlIHBvaW50IGlzIGRpc2NhcmRlZC5cbiAgICpcbiAgICogQHZhciB7bnVtYmVyfSBtaW5EaXN0YW5jZVxuICAgKiBAbWVtYmVyT2YgU1ZHUGF0aEludGVycG9sYXRvciNcbiAgICogQGRlZmF1bHQgMC41XG4gICAqL1xuICBtaW5EaXN0YW5jZSA9IDAuNTtcblxuICAvKipcbiAgICogcm91bmRUb05lYXJlc3QgaXMgdXNlZnVsIHdoZW4gc25hcHBpbmcgdG8gZnJhY3Rpb25hbFxuICAgKiBwaXhlbCB2YWx1ZXMuIEZvciBleGFtcGxlLCBpZiByb3VuZFRvTmVhcmVzdCBpcyAuMjUsXG4gICAqIGEgc2FtcGxlIHJlc3VsdGluZyBpbiB0aGUgcG9pbnQgMi4zNDMyMDAwOTIsNC42MTAwOTIzXG4gICAqIHdpbGwgcm91bmQgdG8gMi4yNSw0LjUuXG4gICAqXG4gICAqIEB2YXIge251bWJlcn0gcm91bmRUb05lYXJlc3RcbiAgICogQG1lbWJlck9mIFNWR1BhdGhJbnRlcnBvbGF0b3IjXG4gICAqIEBkZWZhdWx0IDAuMjVcbiAgICovXG4gIHJvdW5kVG9OZWFyZXN0ID0gMC4yNTtcblxuICAvKipcbiAgICogc2FtcGxlRnJlcXVlbmN5IGRldGVybWluZXMgdGhlIGluY3JlbWVudCBvZiB0IHdoZW4gc2FtcGxpbmcuXG4gICAqIElmIHNhbXBsZUZyZXF1ZW5jeSBpcyBzZXQgdG8gLjAwMSAsIHNpbmNlIHQgaXRlcmF0ZXMgZnJvbVxuICAgKiAwIHRvIDEsIHRoZXJlIHdpbGwgYmUgMTAwMCBwb2ludHMgc2FtcGxlZCBwZXIgY29tbWFuZFxuICAgKiBidXQgb25seSBwb2ludHMgdGhhdCBhcmUgZ3JlYXRlciB0aGFuIG1pbkRpc3RhbmNlIGFyZSBjYXB0dXJlZC5cbiAgICpcbiAgICogQHZhciB7bnVtYmVyfSBzYW1wbGVGcmVxdWVuY3lcbiAgICogQG1lbWJlck9mIFNWR1BhdGhJbnRlcnBvbGF0b3IjXG4gICAqIEBkZWZhdWx0IDAuMDAxXG4gICAqL1xuICBzYW1wbGVGcmVxdWVuY3kgPSAwLjAwMTtcblxuICAvKipcbiAgICogV2hlbiB0cnVlLCBwcmV0dHkgY3JlYXRlcyBmb3JtYXR0ZWQganNvbiBvdXRwdXQuXG4gICAqXG4gICAqIEB2YXIge2Jvb2xlYW59IHByZXR0eVxuICAgKiBAbWVtYmVyT2YgU1ZHUGF0aEludGVycG9sYXRvciNcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHByZXR0eSA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBUaGVuIG51bWJlciBvZiBzcGFjZXMgdG8gaW5kZW50IHdoZW4gcHJldHR5IGlzIHRydWUuXG4gICAqXG4gICAqIEB2YXIge2ludH0gcHJldHR5SW5kZW50XG4gICAqIEBtZW1iZXJPZiBTVkdQYXRoSW50ZXJwb2xhdG9yI1xuICAgKiBAZGVmYXVsdCAwXG4gICAqL1xuICBwcmV0dHlJbmRlbnQgPSAwO1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGpvaW4gcGF0aCBkYXRhIGludG8gYSBzaW5nbGUgZmxhdCBhcnJheS5cbiAgICpcbiAgICogQHZhciB7Ym9vbGVhbn0gam9pblBhdGhEYXRhXG4gICAqIEBtZW1iZXJPZiBTVkdQYXRoSW50ZXJwb2xhdG9yI1xuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgam9pblBhdGhEYXRhID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIFRoZSBTYXhXYXNtIHBhcnNlciBpbnN0YW5jZTtcbiAgICogQHZhciB7IFNBWFBhcnNlciB9IHBhcnNlclxuICAgKiBAbWVtYmVyT2YgU1ZHUGF0aEludGVycG9sYXRvciNcbiAgICogQGRlZmF1bHQgbnVsbFxuICAgKi9cbiAgcGFyc2VyOiBTQVhQYXJzZXI7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBTVkdJbnRlcnBvbGF0b3JDb25maWcgPSB7XG4gICAgam9pblBhdGhEYXRhOiBmYWxzZSxcbiAgICBtaW5EaXN0YW5jZTogKzAuNSxcbiAgICByb3VuZFRvTmVhcmVzdDogKzAuMjUsXG4gICAgc2FtcGxlRnJlcXVlbmN5OiArMC4wMDEsXG4gICAgcGFyc2VyOiBudWxsXG4gIH0pIHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIGNvbmZpZyk7XG4gIH1cblxuICBwYXJzZUFyZ3VtZW50cyhzb3VyY2U6IHN0cmluZyk6IChzdHJpbmcgfCBudW1iZXIpW10ge1xuICAgIGNvbnN0IGFyZ3M6IChzdHJpbmcgfCBudW1iZXIpW10gPSBbXTtcbiAgICBsZXQgYXJnO1xuICAgIHdoaWxlIChhcmcgPSBhcmd1bWVudHNSZWdFeC5leGVjKHNvdXJjZSkpIHtcbiAgICAgIGlmIChpc0Zpbml0ZSgrYXJnWzFdKSkge1xuICAgICAgICBhcmdzLnB1c2goK2FyZ1sxXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhcmdzLnB1c2goYXJnWzFdKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFyZ3M7XG4gIH1cblxuICBwcm9jZXNzU1ZHKGRhdGE6IFVpbnQ4QXJyYXkpOiBudW1iZXJbXSB8IFJlY29yZDxzdHJpbmcsIG51bWJlcltdPiB7XG4gICAgY29uc3Qgb3BlblRhZ3NEZXB0aDogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuICAgIGNvbnN0IHRyYW5zZm9ybXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBsZXQgaW50ZXJwb2xhdGVkUGF0aHMgPSB0aGlzLmpvaW5QYXRoRGF0YSA/IFtdOnt9O1xuICAgIGxldCBpID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLnBhcnNlci5ldmVudEhhbmRsZXIgPSAoZXZlbnQsIG5vZGU6IFRhZykgPT4ge1xuICAgICAgaWYgKGV2ZW50PT09U2F4RXZlbnRUeXBlLk9wZW5UYWcpIHtcbiAgICAgICAgaWYgKCFvcGVuVGFnc0RlcHRoW25vZGUubmFtZV0pIHtcbiAgICAgICAgICBvcGVuVGFnc0RlcHRoW25vZGUubmFtZV0gPSAwO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRlcHRoID0gb3BlblRhZ3NEZXB0aFtub2RlLm5hbWVdKys7XG4gICAgICAgIGNvbnN0IHRyYW5zZm9ybSA9IG5vZGUuYXR0cmlidXRlcy5maW5kKGF0dHIgPT4gYXR0ci5uYW1lLnZhbHVlPT09J3RyYW5zZm9ybScpXG4gICAgICAgIGlmICh0cmFuc2Zvcm0pIHtcbiAgICAgICAgICB0cmFuc2Zvcm1zW2RlcHRoICsgbm9kZS5uYW1lXSA9IHRyYW5zZm9ybS52YWx1ZS52YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChub2RlLm5hbWU9PT0ncGF0aCcpIHtcbiAgICAgICAgICBjb25zdCBwID0gbm9kZS5hdHRyaWJ1dGVzLmZpbmQoYXR0ciA9PiBhdHRyLm5hbWUudmFsdWU9PT0nZCcpXG4gICAgICAgICAgY29uc3QgcG9pbnRzID0gdGhpcy5pbnRlcnBvbGF0ZVBhdGgocC52YWx1ZS52YWx1ZSk7XG4gICAgICAgICAgdGhpcy5hcHBseVRyYW5zZm9ybXModHJhbnNmb3JtcywgcG9pbnRzKTtcbiAgICAgICAgICBpZiAoIXRoaXMuam9pblBhdGhEYXRhKSB7XG4gICAgICAgICAgICBjb25zdCBpZCA9IG5vZGUuYXR0cmlidXRlcy5maW5kKGF0dHIgPT4gYXR0ci5uYW1lLnZhbHVlPT09J2lkJylcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IGlkID8gaWQudmFsdWUudmFsdWU6YHBhdGhfJHsgaSsrIH1gO1xuICAgICAgICAgICAgKGludGVycG9sYXRlZFBhdGhzIGFzIFJlY29yZDxzdHJpbmcsIG51bWJlcltdPilba2V5XSA9IHBvaW50cztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW50ZXJwb2xhdGVkUGF0aHMgPSAoaW50ZXJwb2xhdGVkUGF0aHMgYXMgbnVtYmVyW10pLmNvbmNhdChwb2ludHMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZGVwdGggPSAtLW9wZW5UYWdzRGVwdGhbbm9kZS5uYW1lXTtcbiAgICAgICAgZGVsZXRlIHRyYW5zZm9ybXNbZGVwdGggKyBub2RlLm5hbWVdO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnBhcnNlci53cml0ZShkYXRhKTtcbiAgICB0aGlzLnBhcnNlci5lbmQoKTtcbiAgICByZXR1cm4gaW50ZXJwb2xhdGVkUGF0aHM7XG4gIH1cblxuICBhcHBseVRyYW5zZm9ybXModHJhbnNmb3JtczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiwgcG9pbnRzOiBudW1iZXJbXSkge1xuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh0cmFuc2Zvcm1zKTtcbiAgICBpZiAoIWtleXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChrZXlzLmxlbmd0aCA8IDEpIHtcbiAgICAgIGtleXMuc29ydCgpLnJldmVyc2UoKTtcbiAgICB9XG4gICAga2V5cy5mb3JFYWNoKGRlcHRoID0+IHtcbiAgICAgIGNvbnN0IHN2Z1RyYW5zZm9ybSA9IG5ldyBTVkdUcmFuc2Zvcm0oKTtcbiAgICAgIGNvbnN0IHJhd1RyYW5zZm9ybSA9IHRyYW5zZm9ybXNbZGVwdGhdO1xuICAgICAgY29uc3QgWywgdHlwZSwgcmF3QXJndW1lbnRzXSA9IHRyYW5zZm9ybVJlZ0V4LmV4ZWMocmF3VHJhbnNmb3JtKTtcbiAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLnBhcnNlQXJndW1lbnRzKHJhd0FyZ3VtZW50cyk7XG4gICAgICBzdmdUcmFuc2Zvcm1bdHlwZSBhcyBDYWxsYWJsZVN2Z1RyYW5zZm9ybV0uY2FsbChzdmdUcmFuc2Zvcm0sIC4uLmFyZ3MpO1xuXG4gICAgICBjb25zdCBsZW4gPSBwb2ludHMubGVuZ3RoO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikge1xuICAgICAgICBjb25zdCB7IHgsIHkgfSA9IHN2Z1RyYW5zZm9ybS5tYXAocG9pbnRzW2ldLCBwb2ludHNbaSArIDFdKTtcbiAgICAgICAgcG9pbnRzW2ldID0geCAtICh4ICUgdGhpcy5yb3VuZFRvTmVhcmVzdCk7XG4gICAgICAgIHBvaW50c1tpICsgMV0gPSB5IC0gKHkgJSB0aGlzLnJvdW5kVG9OZWFyZXN0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGludGVycG9sYXRlUGF0aChwYXRoOiBzdHJpbmcpOiBudW1iZXJbXSB7XG4gICAgY29uc3QgZGF0YSA9IFtdO1xuICAgIGxldCBzdWJQYXRoU3RhcnRYID0gMDtcbiAgICBsZXQgc3ViUGF0aFN0YXJ0WSA9IDA7XG4gICAgbGV0IG9mZnNldFggPSAwO1xuICAgIGxldCBvZmZzZXRZID0gMDtcbiAgICBsZXQgYXJncztcbiAgICBsZXQgbWF0Y2g7XG4gICAgbGV0IGxhc3RDb21tYW5kID0geyBjb21tYW5kOiAnJywgcG9pbnRzOiB1bmRlZmluZWQsIG9mZnNldHM6IHVuZGVmaW5lZCB9O1xuICAgIHdoaWxlIChtYXRjaCA9IGNvbW1hbmRSZWdFeC5leGVjKHBhdGgpKSB7XG4gICAgICBjb25zdCBbLCBjb21tYW5kLCByYXdBcmd1bWVudHNdID0gbWF0Y2g7XG4gICAgICBsZXQgcG9pbnRzID0gdGhpcy5wYXJzZUFyZ3VtZW50cyhyYXdBcmd1bWVudHMpIGFzIG51bWJlcltdO1xuXG4gICAgICBzd2l0Y2ggKGNvbW1hbmQpIHtcbiAgICAgICAgY2FzZSAnQSc6XG4gICAgICAgIGNhc2UgJ0MnOlxuICAgICAgICBjYXNlICdMJzpcbiAgICAgICAgY2FzZSAnUSc6XG4gICAgICAgICAgcG9pbnRzLnVuc2hpZnQob2Zmc2V0WCwgb2Zmc2V0WSk7XG4gICAgICAgICAgYXJncyA9IFtwb2ludHNdO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ1MnOlxuICAgICAgICBjYXNlICdzJzpcbiAgICAgICAgY2FzZSAnVCc6XG4gICAgICAgIGNhc2UgJ3QnOlxuICAgICAgICAgIGxldCBsYXN0Q3RybFg7XG4gICAgICAgICAgbGV0IGxhc3RDdHJsWTtcbiAgICAgICAgICBjb25zdCB7IGNvbW1hbmQ6IGxhc3RDLCBwb2ludHM6IGxhc3RQIH0gPSBsYXN0Q29tbWFuZDtcbiAgICAgICAgICBjb25zdCByZWcgPSBjb21tYW5kLnRvTG93ZXJDYXNlKCk9PT0ncycgPyAvXltjc10kLzovXltxdF0kLztcbiAgICAgICAgICBpZiAocmVnLnRlc3QobGFzdEMudG9Mb3dlckNhc2UoKSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBsYXN0UDtcbiAgICAgICAgICAgIGxhc3RDdHJsWSA9IGxhc3RQW2xlbmd0aCAtIDNdO1xuICAgICAgICAgICAgbGFzdEN0cmxYID0gbGFzdFBbbGVuZ3RoIC0gNF07XG4gICAgICAgICAgfVxuICAgICAgICAgIGFyZ3MgPSBwb2ludHM7XG5cbiAgICAgICAgICBpZiAoL15bc3RdJC8udGVzdChjb21tYW5kKSkge1xuICAgICAgICAgICAgdGhpcy5hcHBseU9mZnNldChvZmZzZXRYLCBvZmZzZXRZLCBhcmdzLCA0KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYXJncy51bnNoaWZ0KG9mZnNldFgsIG9mZnNldFksIGxhc3RDdHJsWCwgbGFzdEN0cmxZKTtcbiAgICAgICAgICBhcmdzID0gW2FyZ3NdO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2EnOlxuICAgICAgICAgIHBvaW50cy51bnNoaWZ0KDAsIDApO1xuICAgICAgICAgIGFyZ3MgPSBbdGhpcy5hcHBseU9mZnNldChvZmZzZXRYLCBvZmZzZXRZLCBwb2ludHMsIDcpXTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdjJzpcbiAgICAgICAgICB0aGlzLmFwcGx5T2Zmc2V0KG9mZnNldFgsIG9mZnNldFksIHBvaW50cywgNik7XG4gICAgICAgICAgcG9pbnRzLnVuc2hpZnQob2Zmc2V0WCwgb2Zmc2V0WSk7XG4gICAgICAgICAgYXJncyA9IFtwb2ludHNdO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2wnOlxuICAgICAgICAgIHBvaW50cy51bnNoaWZ0KDAsIDApO1xuICAgICAgICAgIGFyZ3MgPSBbdGhpcy5hcHBseU9mZnNldChvZmZzZXRYLCBvZmZzZXRZLCBwb2ludHMsIDIpXTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdxJzpcbiAgICAgICAgICBwb2ludHMudW5zaGlmdCgwLCAwKTtcbiAgICAgICAgICBhcmdzID0gW3RoaXMuYXBwbHlPZmZzZXQob2Zmc2V0WCwgb2Zmc2V0WSwgcG9pbnRzLCA0KV07XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnSCc6XG4gICAgICAgICAgcG9pbnRzLnVuc2hpZnQob2Zmc2V0WCwgb2Zmc2V0WSk7XG4gICAgICAgICAgcG9pbnRzLnB1c2gob2Zmc2V0WSk7XG4gICAgICAgICAgYXJncyA9IFtwb2ludHNdO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ2gnOlxuICAgICAgICAgIHRoaXMuYXBwbHlPZmZzZXQob2Zmc2V0WCwgb2Zmc2V0WCwgcG9pbnRzLCAyKTsgLy8gb2Zmc2V0WCwgb2Zmc2V0WCBpcyBpbnRlbnRpb25hbFxuICAgICAgICAgIHBvaW50cy51bnNoaWZ0KG9mZnNldFgsIG9mZnNldFkpO1xuICAgICAgICAgIHBvaW50cy5wdXNoKG9mZnNldFkpO1xuICAgICAgICAgIGFyZ3MgPSBbcG9pbnRzXTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdtJzpcbiAgICAgICAgICBzdWJQYXRoU3RhcnRYID0gcG9pbnRzWzBdICsgb2Zmc2V0WDtcbiAgICAgICAgICBzdWJQYXRoU3RhcnRZID0gcG9pbnRzWzFdICsgb2Zmc2V0WTtcbiAgICAgICAgICBhcmdzID0gW3RoaXMuYXBwbHlPZmZzZXQob2Zmc2V0WCwgb2Zmc2V0WSwgcG9pbnRzLnNsaWNlKDIpLCAyKV07XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnTSc6XG4gICAgICAgICAgc3ViUGF0aFN0YXJ0WCA9IHBvaW50c1swXTtcbiAgICAgICAgICBzdWJQYXRoU3RhcnRZID0gcG9pbnRzWzFdO1xuICAgICAgICAgIGFyZ3MgPSBbcG9pbnRzLnNsaWNlKDIpXTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdWJzpcbiAgICAgICAgICBwb2ludHMudW5zaGlmdChvZmZzZXRYLCBvZmZzZXRZLCBvZmZzZXRYKTtcbiAgICAgICAgICBhcmdzID0gW3BvaW50c107XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAndic6XG4gICAgICAgICAgdGhpcy5hcHBseU9mZnNldChvZmZzZXRZLCBvZmZzZXRZLCBwb2ludHMsIDIpOyAvLyBvZmZzZXRZLCBvZmZzZXRZIGlzIGludGVudGlvbmFsXG4gICAgICAgICAgcG9pbnRzLnVuc2hpZnQob2Zmc2V0WCwgb2Zmc2V0WSwgb2Zmc2V0WCk7XG4gICAgICAgICAgYXJncyA9IFtwb2ludHNdO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ3onOlxuICAgICAgICBjYXNlICdaJzpcbiAgICAgICAgICBwb2ludHMgPSBbb2Zmc2V0WCwgb2Zmc2V0WSwgc3ViUGF0aFN0YXJ0WCwgc3ViUGF0aFN0YXJ0WV07XG4gICAgICAgICAgYXJncyA9IFtwb2ludHNdO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgY29uc3QgY2FsY3VsYXRvciA9IGNhbGN1bGF0b3JzW2NvbW1hbmQudG9Mb3dlckNhc2UoKV07XG4gICAgICBjb25zdCBvZmZzZXRzID0geyBvZmZzZXRYLCBvZmZzZXRZIH07XG4gICAgICBpZiAoY2FsY3VsYXRvcikge1xuICAgICAgICBhcmdzLnB1c2godGhpcy5taW5EaXN0YW5jZSwgdGhpcy5yb3VuZFRvTmVhcmVzdCwgdGhpcy5zYW1wbGVGcmVxdWVuY3kpO1xuICAgICAgICBjb25zdCBwdHMgPSBjYWxjdWxhdG9yKC4uLmFyZ3MpO1xuICAgICAgICBkYXRhLnB1c2goLi4ucHRzKTtcbiAgICAgICAgY29uc3QgbGVuID0gfn5wb2ludHMubGVuZ3RoO1xuXG4gICAgICAgIG9mZnNldFkgPSBwb2ludHNbbGVuIC0gMV07XG4gICAgICAgIG9mZnNldFggPSBwb2ludHNbbGVuIC0gMl07XG4gICAgICB9XG4gICAgICBsYXN0Q29tbWFuZCA9IHsgY29tbWFuZCwgcG9pbnRzLCBvZmZzZXRzIH07XG4gICAgfVxuICAgIGlmICh0aGlzLnRyaW0pIHtcbiAgICAgIHRoaXMudHJpbVBhdGhPZmZzZXRzKGRhdGEpO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHRyaW1QYXRoT2Zmc2V0cyhwYXRoczogbnVtYmVyW10pIHtcbiAgICBsZXQgbWluWCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcbiAgICBsZXQgbWluWSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcbiAgICBsZXQgaSA9IHBhdGhzLmxlbmd0aDtcbiAgICBsZXQgeDtcbiAgICBsZXQgeTtcbiAgICBpZiAoIWkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgd2hpbGUgKGkgLT0gMikge1xuICAgICAgeCA9IHBhdGhzW2ldO1xuICAgICAgeSA9IHBhdGhzW2kgLSAxXTtcbiAgICAgIGlmICh4IDwgbWluWCkge1xuICAgICAgICBtaW5YID0geDtcbiAgICAgIH1cbiAgICAgIGlmICh5IDwgbWluWSkge1xuICAgICAgICBtaW5ZID0geTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpID0gcGF0aHMubGVuZ3RoO1xuICAgIHdoaWxlIChpIC09IDIpIHtcbiAgICAgIHBhdGhzW2ldIC09IG1pblg7XG4gICAgICBwYXRoc1tpIC0gMV0gLT0gbWluWTtcbiAgICB9XG4gIH1cblxuICBhcHBseU9mZnNldChvZmZzZXRYOiBudW1iZXIsIG9mZnNldFk6IG51bWJlciwgY29vcmRzOiBudW1iZXJbXSA9IFtdLCBzZXRMZW5ndGggPSAyKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb29yZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChpICYmIGkgJSArc2V0TGVuZ3RoPT09MCkge1xuICAgICAgICBvZmZzZXRYID0gY29vcmRzW2kgLSAyXTtcbiAgICAgICAgb2Zmc2V0WSA9IGNvb3Jkc1tpIC0gMV07XG4gICAgICB9XG4gICAgICBjb29yZHNbaV0gKz0gKGkgJSAyID8gK29mZnNldFk6K29mZnNldFgpO1xuICAgIH1cbiAgICByZXR1cm4gY29vcmRzO1xuICB9XG59XG4iXX0=